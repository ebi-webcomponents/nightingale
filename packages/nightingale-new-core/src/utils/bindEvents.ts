import NightingaleBaseElement from "../nightingale-base-element";
import { WithHighlightInterface } from "../mixins/withHighlight";
import { Selection, BaseType } from "d3";

export const HIGHLIGHT_EVENT = "highlight-event";

type EventType = "click" | "mouseover" | "mouseout" | "reset";

type FeatureData = {
  feature?: FeatureData | null;
  fragments?: Array<{
    start: number;
    end: number;
  }>;
  start?: number;
  end?: number;
  protvistaFeatureId: string;
};
type SequenceBaseData = {
  position: number;
  aa: string;
};

type detailInterface = {
  eventType: EventType;
  coords: null | [number, number];
  feature?: FeatureData | SequenceBaseData | null;
  target?: HTMLElement;
  highlight?: string;
  selectedId?: string | null;
  parentEvent?: Event;
};

export function createEvent(
  type: EventType,
  feature: FeatureData | SequenceBaseData | null = null,
  withHighlight = false,
  withId = false,
  start?: number,
  end?: number,
  target?: HTMLElement,
  event?: Event,
  element?: NightingaleBaseElement & WithHighlightInterface,
): Event {
  // Variation features have a different shape
  if (feature) {
    // eslint-disable-next-line no-param-reassign
    feature = (feature as FeatureData)?.feature || feature;
  }
  const detail: detailInterface = {
    eventType: type,
    // TODO: add coordinates
    // coords: WithNightingaleEvents._getClickCoords(),
    coords: event ? [(event as MouseEvent).clientX, (event as MouseEvent).clientY]: null,
    feature,
    target,
    parentEvent: event,
  };
  if (withHighlight) {
    if ((feature as FeatureData)?.fragments) {
      detail.highlight = ((feature as FeatureData)?.fragments || [])
        .map((fr) => `${fr.start}:${fr.end}`)
        .join(",");
    } else if ((event as KeyboardEvent)?.shiftKey && element?.highlight) {
      // If holding shift, add to the highlights
      detail.highlight = `${element.highlight},${start}:${end}`;
    } else {
      detail.highlight = start && end ? `${start}:${end}` : undefined;
    }
  }
  if (withId) {
    detail.selectedId = (feature as FeatureData)?.protvistaFeatureId;
  }
  return new CustomEvent("change", {
    detail,
    bubbles: true,
    cancelable: true,
  });
}

export default function bindEvents<T extends BaseType>(
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  feature: Selection<T, any, any, any>,
  element: NightingaleBaseElement,
) {
  feature
      .on("mouseover", function (event: MouseEvent, datum: unknown) {
          element.dispatchEvent(
              createEvent(
                  "mouseover",
                  datum as FeatureData | SequenceBaseData,
                  element.getAttribute(HIGHLIGHT_EVENT) === "onmouseover",
                  false,
                  (datum as FeatureData).start ?? (datum as SequenceBaseData).position,
                  (datum as FeatureData).end ?? (datum as SequenceBaseData).position,
                  this as unknown as HTMLElement,
                  event
              )
          );
      })
      .on("mouseout", () => {
          element.dispatchEvent(createEvent("mouseout", null, element.getAttribute(HIGHLIGHT_EVENT) === "onmouseover"));
      })
      .on("click", function (event: MouseEvent, datum: unknown) {
          element.dispatchEvent(
              createEvent(
                  "click",
                  datum as FeatureData | SequenceBaseData,
                  element.getAttribute(HIGHLIGHT_EVENT) === "onclick",
                  true,
                  (datum as FeatureData).start ?? (datum as SequenceBaseData).position,
                  (datum as FeatureData).end ?? (datum as SequenceBaseData).position,
                  this as unknown as HTMLElement,
                  event,
                  element as NightingaleBaseElement & WithHighlightInterface
              )
          );
      });
}
